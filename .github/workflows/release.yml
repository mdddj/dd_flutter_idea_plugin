name: æ„å»ºå‘å¸ƒåˆ›å»º

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—
    
    - name: å‡†å¤‡JBR21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'zulu'

    - name: è·å–æ ‡ç­¾ç‰ˆæœ¬å·
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT 
    
    - name: æˆäºˆgradlewæ‰§è¡Œæƒé™
      run: chmod +x gradlew
      working-directory: dd_flutter_idea_plugin

    - name: æ‰“åŒ…æ’ä»¶
      run: |
        ./gradlew buildPlugin --no-daemon --stacktrace
      working-directory: dd_flutter_idea_plugin
      env:
        GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx1548m -XX:MaxMetaspaceSize=512m"
    
    - name: è·å–æ„å»ºçš„æ’ä»¶åŒ…(æ–‡ä»¶åå’Œè·¯å¾„)
      id: find_plugin
      run: |
        PLUGIN_FILE=$(find build/distributions -name "*.zip" | head -1)
        if [ -z "$PLUGIN_FILE" ]; then
          echo "No plugin file found!"
          exit 1
        fi
        echo "plugin_file=$PLUGIN_FILE" >> $GITHUB_OUTPUT
        echo "plugin_name=$(basename $PLUGIN_FILE)" >> $GITHUB_OUTPUT
        echo "Found plugin: $PLUGIN_FILE"
      working-directory: dd_flutter_idea_plugin
    
    - name: è·å–ç‰ˆæœ¬æ›´æ–°è¯´æ˜
      id: release_notes
      run: |
        CHANGELOG_CONTENT=$(./gradlew getChangelog --quiet)
        echo -n "$CHANGELOG_CONTENT" > release-notes.md
        echo 'changelog<<EOF' >> $GITHUB_OUTPUT
        echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
        echo 'EOF' >> $GITHUB_OUTPUT
      working-directory: dd_flutter_idea_plugin

    - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: FlutterX  ${{ steps.get_version.outputs.tag_name }}
        body_path: dd_flutter_idea_plugin/release-notes.md
        files: |
          dd_flutter_idea_plugin/${{ steps.find_plugin.outputs.plugin_file }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ä¸Šä¼ èµ„äº§æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: FlutterX-${{ steps.get_version.outputs.version }}
        path: dd_flutter_idea_plugin/${{ steps.find_plugin.outputs.plugin_file }}
        retention-days: 30

    - name: æ’ä»¶éªŒè¯
      run: |
        echo "âœ… Plugin built successfully!"
        echo "ğŸ“ Plugin file: ${{ steps.find_plugin.outputs.plugin_name }}"
        echo "ğŸ·ï¸ Version: ${{ steps.get_version.outputs.version }}"
        echo "ğŸ“¦ Release created: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag_name }}"
      working-directory: dd_flutter_idea_plugin